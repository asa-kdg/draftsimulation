{% extends "draft/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/draft_style.css' %}?v={% now 'U' %}">
{% endblock %}

{% block content %}
<div class="simulation-container">
    <div class="draft-header">
        {% if request.session.draft_phase == "1st_round" %}
            <h2>第一巡 選択希望選手 (入札方式)</h2>
            <p>進捗: {{ request.session.current_bids|length }} / 12 球団</p>
        {% else %}
            <h2>第 {{ round }} 巡目 指名開始</h2>
        {% endif %}
    </div>

    <div class="draft-grid">
        {% for t in teams %}
        <div class="team-card {% if t.name == team.name %}active{% endif %}">
            
            <div class="team-line-top" style="background-color: {{ t.first_color|default:'#ccc' }};"></div>
    
            <h3>{{ t.name }}</h3>
            
            <div class="picks-display">
                {% for p in t.picks %}
                    <div class="pick-item">
                        {{ forloop.counter }}位：<strong>{{ p.name }}</strong>
                    </div>
                {% empty %}
                    <div class="text-muted" style="text-align: center; margin-top: 20px;">（指名待ち）</div>
                {% endfor %}
            </div>
    
            {% if t.name == team.name %}
            <div class="card-footer">
                <button type="button" 
                        onclick="document.getElementById('playerModal').style.display='block'; document.body.style.overflow='hidden';" 
                        class="submit-btn">選手を選択する
                </button>
            </div>
            {% endif %}
    
            <div class="team-line-bottom" style="background-color: {{ t.second_color|default:'#eee' }};"></div>
        </div>
        {% endfor %}
    </div>

</div>

<div id="playerModal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);">
    <div class="modal-content" style="background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 15px; overflow-y: auto; position: relative;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">選手選択：{{ team.name }}</h2>
            <span class="close-btn" 
                  onclick="document.getElementById('playerModal').style.display='none'; document.body.style.overflow='auto';" 
                  style="font-size: 32px; cursor: pointer;">&times;</span>
        </div>
        
        <form method="post" action="{% url 'draft:pick_player' %}">
            {% csrf_token %}
            <div class="search-box">
                <input type="text" id="innerSearch" placeholder="選手名・所属で検索..." 
                       style="width: 100%; padding: 12px; border-radius: 25px; border: 2px solid #007bff; margin-bottom: 20px; outline: none;">
            </div>

            <div id="playerList" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                {% for p in players %}
                <label class="player-card category-{{ p.team_category }}" 
                       data-name="{{ p.name }}" data-team="{{ p.team }}"
                       style="display: block; position: relative; border: 1px solid #ddd; border-radius: 8px; padding: 12px; cursor: pointer; background: #fff;">
                    <input type="radio" name="player_id" value="{{ p.id }}" required style="position: absolute; top: 12px; right: 12px; transform: scale(1.3);">
                    <div style="pointer-events: none;">
                        <span class="pos-badge pos-{{ p.position }}">{{ p.get_position_display }}</span>
                        <div>
                            <strong>{{ p.name }}</strong><br>
                            <small>{{ p.team }} {{ p.category }}</small>
                        </div>
                    </div>
                </label>
                {% endfor %}
            </div>

            <div style="text-align: center; margin-top: 20px; position: sticky; bottom: 0; background: white; padding: 10px;">
                <button type="submit" class="confirm-btn"  class="confirm-btn">指名を確定する</button>
            </div>
        </form>
    </div>
</div>

<script>
    // 検索機能の再定義（ID重複を避けるため innerSearch に変更）
    const searchInput = document.getElementById('innerSearch');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#playerList .player-card').forEach(card => {
                const name = card.getAttribute('data-name').toLowerCase();
                const team = card.getAttribute('data-team').toLowerCase();
                card.style.display = (name.includes(query) || team.includes(query)) ? 'block' : 'none';
            });
        });
    }

    // モーダルの外側をクリックしたら閉じる
    window.onclick = function(event) {
        const modal = document.getElementById('playerModal');
        if (event.target == modal) {
            modal.style.display = "none";
            document.body.style.overflow = 'auto';
        }
    }
</script>
{% endblock %}